<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Quest - Learn Law Through Adventure</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
        }
        
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            z-index: 100;
        }
        
        .game-title {
            color: #ffd700;
            font-size: 14px;
            text-shadow: 2px 2px 0 #000;
        }
        
        .back-btn {
            background: linear-gradient(180deg, #4a4a7a 0%, #3a3a5a 100%);
            border: 2px solid #6a6a9a;
            color: #e0e0e0;
            padding: 10px 16px;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: linear-gradient(180deg, #5a5a8a 0%, #4a4a6a 100%);
            border-color: #8a8aba;
        }
        
        #gameContainer {
            position: relative;
            border: 4px solid #4a4a6a;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(100, 100, 200, 0.3);
            background-image: url("{{ url_for('static', filename='rpg_assets/background.png') }}");
            background-size: cover;
            background-position: center;
        }
        
        #gameCanvas {
            display: block;
            background: transparent;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #dialogueBox {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 700px;
            background: linear-gradient(180deg, #2d2d4a 0%, #1a1a2e 100%);
            border: 3px solid #6a6a9a;
            border-radius: 8px;
            padding: 15px 20px;
            display: none;
            pointer-events: auto;
        }
        
        #dialogueBox.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        #speakerName {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #000;
        }
        
        #dialogueText {
            color: #e0e0e0;
            font-size: 12px;
            line-height: 1.8;
            min-height: 60px;
        }
        
        #choices {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .choice-btn {
            background: linear-gradient(180deg, #4a4a7a 0%, #3a3a5a 100%);
            border: 2px solid #6a6a9a;
            color: #e0e0e0;
            padding: 12px 16px;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            border-radius: 4px;
        }
        
        .choice-btn:hover {
            background: linear-gradient(180deg, #5a5a8a 0%, #4a4a6a 100%);
            border-color: #8a8aba;
            transform: translateX(5px);
        }
        
        .choice-btn::before {
            content: '▸ ';
            color: #ffd700;
        }
        
        #hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: #888;
            font-size: 8px;
            text-shadow: 1px 1px 0 #000;
        }
        
        #locationName {
            position: absolute;
            top: 15px;
            left: 15px;
            color: #ffd700;
            font-size: 10px;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.6);
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        #controls {
            margin-top: 20px;
            color: #6a6a9a;
            font-size: 10px;
            text-align: center;
        }
        
        #controls span {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <div class="game-title">Legal Quest RPG</div>
        <a href="{{ url_for('mode_select') }}" class="back-btn">← Back to Menu</a>
    </div>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="ui">
            <div id="locationName">Town Square</div>
            <div id="dialogueBox">
                <div id="speakerName"></div>
                <div id="dialogueText"></div>
                <div id="choices"></div>
            </div>
            <div id="hint">Explore the town</div>
        </div>
    </div>
    <div id="controls">
        <span>WASD</span> or <span>Arrow Keys</span> to move | <span>E</span> or <span>ENTER</span> to interact
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const TILE_SIZE = 32;
            path: '#8b7355',
            pathLight: '#a08060',
            water: '#4a90c2',
            waterDark: '#3a70a2',
            wall: '#6a6a7a',
            roof: '#8b4513',
            roofDark: '#6b3503',
            wood: '#a0522d',
            window: '#87ceeb',
            door: '#654321'
        };
        
        const TILE_SIZE = 32;
        
        const gameState = {
            player: { x: 12, y: 9, direction: 'down' },
            npcs: [],
            buildings: [],
            currentDialogue: null,
            dialogueIndex: 0,
            showChoices: false,
            currentScenario: null,
            scenarioIndex: 0,
            learnedConcepts: new Set()
        };
        
        let walkableMap = null;
        
        const bgForCollision = new Image();
        bgForCollision.src = '{{ url_for("static", filename="rpg_assets/background.png") }}';
        bgForCollision.onload = () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 800;
            tempCanvas.height = 600;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(bgForCollision, 0, 0, 800, 600);
            const imageData = tempCtx.getImageData(0, 0, 800, 600);
            
            walkableMap = [];
            for (let y = 0; y < 600; y += TILE_SIZE) {
                const row = [];
                for (let x = 0; x < 800; x += TILE_SIZE) {
                    const px = x + TILE_SIZE / 2;
                    const py = y + TILE_SIZE / 2;
                    const index = (Math.floor(py) * 800 + Math.floor(px)) * 4;
                    const r = imageData.data[index];
                    const g = imageData.data[index + 1];
                    const b = imageData.data[index + 2];
                    const brightness = (r + g + b) / 3;
                    row.push(brightness > 60);
                }
                walkableMap.push(row);
            }
            console.log('Walkable map created');
        };
        
        function isTileWalkable(tileX, tileY) {
            if (!walkableMap) return true;
            if (tileY < 0 || tileY >= walkableMap.length || tileX < 0 || tileX >= walkableMap[0].length) {
                return false;
            }
            return walkableMap[tileY][tileX];
        }
        
        const sprites = {
            player: null,
            judge: null,
            police: null,
            lawyer: null,
            citizen: null
        };
        
        const playerImg = new Image();
        playerImg.src = '{{ url_for("static", filename="rpg_assets/Main Character.png") }}';
        playerImg.onload = () => {
            sprites.player = playerImg;
            console.log('Player sprite loaded!');
        };
        
        const map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,3,3,3,2,2,2,2,2,2,3,3,3,2,2,1],
            [1,2,3,3,3,2,2,2,2,2,2,3,3,3,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        
        function initBuildings() {
            gameState.buildings = [
                { name: 'Courthouse', x: 2, y: 2, width: 4, height: 3, color: '#8b7355', roofColor: '#654321', npc: 'judge' },
                { name: 'Police Station', x: 11, y: 2, width: 4, height: 3, color: '#4a6fa5', roofColor: '#2c3e50', npc: 'police' },
                { name: 'Law Library', x: 2, y: 8, width: 3, height: 3, color: '#6b4423', roofColor: '#4a2f18', npc: 'lawyer' },
                { name: 'Town Square', x: 7, y: 5, width: 3, height: 2, color: '#5a7a5a', roofColor: null, npc: 'citizen' }
            ];
            
            gameState.npcs = [
                { id: 'judge', name: 'Judge Thompson', sprite: 'judge', x: 12, y: 4, scenarios: getJudgeScenarios() },
                { id: 'police', name: 'Officer Martinez', sprite: 'police', x: 20, y: 14, scenarios: getPoliceScenarios() },
                { id: 'lawyer', name: 'Attorney Chen', sprite: 'lawyer', x: 3, y: 10, scenarios: getLawyerScenarios() },
                { id: 'citizen', name: 'Mr. Johnson', sprite: 'citizen', x: 12, y: 10, scenarios: getCitizenScenarios() }
            ];
        }
        
        function getJudgeScenarios() {
            return [
                {
                    intro: "Welcome, young law student! I'm Judge Thompson. The courthouse is the heart of our justice system. Would you like to learn about the judicial process?",
                    concept: "Judicial Process",
                    choices: [
                        { text: "Yes, explain how courts work!", next: { concept: "The judicial process involves courts interpreting and applying laws to resolve disputes. Judges ensure fair trials and equal protection under the law.", feedback: "Excellent! Remember, courts provide a forum for peaceful dispute resolution." }},
                        { text: "What's a typical court case like?", next: { concept: "A typical case starts with a complaint, followed by evidence presentation, witness testimony, and finally a judgment. Due process ensures everyone gets a fair hearing.", feedback: "Due process is a fundamental constitutional right!" }},
                        { text: "Can anyone become a judge?", next: { concept: "Judges are typically appointed or elected after years of legal practice. They must have extensive knowledge of the law and demonstrate impartiality.", feedback: "Judicial appointments are important political processes!" }}
                    ]
                },
                {
                    intro: "Today we'll discuss constitutional law. The Constitution is the supreme law of the land. Do you have a specific question?",
                    concept: "Constitutional Law",
                    choices: [
                        { text: "What are my basic rights?", next: { concept: "Basic rights include freedom of speech, religion, assembly, and the right to due process. The Bill of Rights protects these fundamental freedoms.", feedback: "These rights form the foundation of our democracy!" }},
                        { text: "How does judicial review work?", next: { concept: "Judicial review allows courts to strike down laws that violate the Constitution. This power was established in Marbury v. Madison (1803).", feedback: "This is one of the most important powers of the judiciary!" }},
                        { text: "What is separation of powers?", next: { concept: "Separation of powers divides government into three branches: legislative (makes laws), executive (enforces laws), and judicial (interprets laws).", feedback: "This prevents any one branch from becoming too powerful!" }}
                    ]
                }
            ];
        }
        
        function getPoliceScenarios() {
            return [
                {
                    intro: "Hello there! I'm Officer Martinez. Law enforcement plays a crucial role in maintaining public safety. Want to learn about your rights when interacting with police?",
                    concept: "Police Interactions",
                    choices: [
                        { text: "What are my rights when stopped?", next: { concept: "You have the right to remain silent, the right to an attorney, and the right to know why you're being detained. You don't have to consent to searches without a warrant.", feedback: "Know your rights! But also be respectful and cooperative." }},
                        { text: "When can police search my belongings?", next: { concept: "Police can search with your consent, a warrant, or if there's probable cause. Vehicles can be searched if contraband is in plain view or with certain exceptions.", feedback: "Probable cause is a key legal concept!" }},
                        { text: "What's the difference between arrest and detainment?", next: { concept: "Arrest means you're being charged with a crime. Detainment is a temporary hold for investigation. Both require different levels of justification.", feedback: "Understanding this distinction is important!" }}
                    ]
                },
                {
                    intro: "Let me tell you about criminal law basics. Criminal law deals with offenses against the state and public safety.",
                    concept: "Criminal Law Basics",
                    choices: [
                        { text: "What's the difference between felony and misdemeanor?", next: { concept: "Felonies are serious crimes punishable by imprisonment over one year or death. Misdemeanors are less serious, typically punishable by fines or short jail time.", feedback: "This classification affects sentencing significantly!" }},
                        { text: "What is 'innocent until proven guilty'?", next: { concept: "This presumption means the burden of proof lies with the prosecution. Defendants don't have to prove their innocence - the state must prove guilt beyond a reasonable doubt.", feedback: "A cornerstone of criminal justice!" }},
                        { text: "What are Miranda rights?", next: { concept: "Miranda rights include the right to remain silent, that anything you say can be used against you, the right to an attorney, and the right to have one provided if you can't afford it.", feedback: "Always invoke your Miranda rights when questioned!" }}
                    ]
                }
            ];
        }
        
        function getLawyerScenarios() {
            return [
                {
                    intro: "Welcome to the Law Library! I'm Attorney Chen. As a lawyer, I help people navigate the complex legal system. What would you like to learn about?",
                    concept: "Legal Profession",
                    choices: [
                        { text: "What does a lawyer actually do?", next: { concept: "Lawyers provide legal advice, represent clients in court, draft legal documents, negotiate settlements, and advocate for their clients' interests.", feedback: "Lawyers are essential to accessing justice!" }},
                        { text: "How do I become a lawyer?", next: { concept: "Becoming a lawyer requires: 1) Bachelor's degree, 2) Law school (3 years), 3) Pass the bar exam. Some states allow alternative paths.", feedback: "The bar exam is notoriously challenging!" }},
                        { text: "What's the difference between civil and criminal law?", next: { concept: "Criminal law deals with crimes against the state (fines, imprisonment). Civil law deals with disputes between individuals (compensation, contracts).", feedback: "Most legal work actually happens in civil court!" }}
                    ]
                },
                {
                    intro: "Let's discuss contract law - essential for everyday life. Contracts are everywhere, from buying phone plans to employment.",
                    concept: "Contract Law",
                    choices: [
                        { text: "What makes a contract valid?", next: { concept: "A valid contract requires: 1) Offer and acceptance, 2) Consideration (something of value), 3) Capacity (both parties can contract), 4) Legal purpose.", feedback: "These four elements are crucial!" }},
                        { text: "Can I break a contract?", next: { concept: "Breaking a contract (breach) allows the other party to seek damages. However, some breaches may be excused due to impossibility or frustration of purpose.", feedback: "Always consider legal consequences before breaking agreements!" }},
                        { text: "What is negligence?", next: { concept: "Negligence is a civil wrong where someone fails to act with reasonable care, causing harm to another. Elements: duty, breach, causation, damages.", feedback: "Most personal injury cases are based on negligence!" }}
                    ]
                }
            ];
        }
        
        function getCitizenScenarios() {
            return [
                {
                    intro: "Oh, hello there! I'm just a regular citizen here in town. I had some trouble recently and learned a lot about the legal system. Want to hear about it?",
                    concept: "Consumer Rights",
                    choices: [
                        { text: "What kind of trouble?", next: { concept: "I bought a defective product and the store refused to refund me! I learned about consumer protection laws and warranty rights.", feedback: "Consumer laws protect buyers!" }},
                        { text: "What can I do about defective products?", next: { concept: "You can: 1) Request repair/replacement, 2) Demand a refund, 3) File a complaint with consumer protection agencies, 4) Sue in small claims court.", feedback: "Small claims court is designed for this!" }},
                        { text: "What's a warranty?", next: { concept: "A warranty is a seller's promise about a product's quality. Express warranties are explicit, while implied warranties (merchantability) exist by law.", feedback: "Always read warranty terms carefully!" }}
                    ]
                },
                {
                    intro: "Let me tell you about neighbor disputes - they can get messy! I had an issue with my neighbor about property boundaries.",
                    concept: "Property Law",
                    choices: [
                        { text: "What was the dispute about?", next: { concept: "My neighbor built a fence that crossed onto my property! We had to look at property deeds and boundary laws to resolve it.", feedback: "Property surveys are important!" }},
                        { text: "How do property boundaries work?", next: { concept: "Property boundaries are defined by deeds and surveys. Adverse possession allows someone to gain ownership of land by using it openly for a statutory period.", feedback: "Boundary disputes can become very complex!" }},
                        { text: "What can I do about noisy neighbors?", next: { concept: "You can: 1) Talk to them directly, 2) Check local noise ordinances, 3) Contact the HOA if applicable, 4) Seek legal remedies for nuisance.", feedback: "Noise ordinances vary by location!" }}
                    ]
                }
            ];
        }
        
        let moveCooldown = false;
        
        function startDialogue(npc) {
            const scenarios = npc.scenarios;
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            gameState.currentScenario = scenario;
            gameState.dialogueIndex = 0;
            gameState.learnedConcepts.add(scenario.concept);
            
            showDialogue(npc.name, scenario.intro, scenario.choices);
        }
        
        function showDialogue(speaker, text, choices = null) {
            const dialogueBox = document.getElementById('dialogueBox');
            const speakerName = document.getElementById('speakerName');
            const dialogueText = document.getElementById('dialogueText');
            const choicesDiv = document.getElementById('choices');
            
            speakerName.textContent = speaker;
            dialogueText.textContent = text;
            
            choicesDiv.innerHTML = '';
            if (choices) {
                gameState.showChoices = true;
                choices.forEach((choice, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = choice.text;
                    btn.onclick = () => makeChoice(choice);
                    choicesDiv.appendChild(btn);
                });
            } else {
                gameState.showChoices = false;
            }
            
            dialogueBox.classList.add('active');
        }
        
        function makeChoice(choice) {
            const dialogueText = document.getElementById('dialogueText');
            const choicesDiv = document.getElementById('choices');
            
            dialogueText.innerHTML = `<span style="color: #ffd700;">${choice.next.concept}</span><br><br>${choice.next.feedback}`;
            choicesDiv.innerHTML = '';
            
            const continueBtn = document.createElement('button');
            continueBtn.className = 'choice-btn';
            continueBtn.textContent = 'Continue (Learn more)';
            continueBtn.onclick = () => {
                const npcs = gameState.npcs;
                const currentNpc = npcs.find(n => n.name === document.getElementById('speakerName').textContent);
                if (currentNpc) {
                    const scenarios = currentNpc.scenarios;
                    const newScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                    gameState.currentScenario = newScenario;
                    gameState.learnedConcepts.add(newScenario.concept);
                    showDialogue(currentNpc.name, newScenario.intro, newScenario.choices);
                }
            };
            choicesDiv.appendChild(continueBtn);
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'choice-btn';
            closeBtn.textContent = 'Close (Back to game)';
            closeBtn.onclick = closeDialogue;
            choicesDiv.appendChild(closeBtn);
        }
        
        function advanceDialogue() {
            closeDialogue();
        }
        
        function closeDialogue() {
            document.getElementById('dialogueBox').classList.remove('active');
            gameState.currentDialogue = null;
            gameState.showChoices = false;
            gameState.currentScenario = null;
        }
        
        function updateHint() {
            const player = gameState.player;
            let canInteract = false;
            
            for (let npc of gameState.npcs) {
                const dx = player.x - npc.x;
                const dy = player.y - npc.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 60) {
                    canInteract = true;
                    break;
                }
            }
            
            const hint = document.getElementById('hint');
            if (canInteract) {
                hint.textContent = 'Press E or ENTER to interact';
                hint.style.color = '#ffd700';
            } else {
                hint.textContent = 'Explore the town';
                hint.style.color = '#888';
            }
        }
        
        function updateLocationName() {
            const player = gameState.player;
            const buildings = gameState.buildings;
            let location = 'Town Square';
            
            for (let b of buildings) {
                const bx = b.x + b.width / 2;
                const by = b.y + b.height / 2;
                if (Math.abs(player.x - bx) < 4 && Math.abs(player.y - by) < 3) {
                    location = b.name;
                    break;
                }
            }
            
            document.getElementById('locationName').textContent = location;
        }
        
        function checkCollision(newX, newY) {
            const playerRadius = 12;
            
            if (!isWalkable(newX, newY)) {
                return true;
            }
            
            for (let npc of gameState.npcs) {
                const dx = newX - npc.x;
                const dy = newY - npc.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 30) return true;
            }
            
            if (newX < 25 || newX > canvas.width - 25 || newY < 25 || newY > canvas.height - 25) {
                return true;
            }
            
            return false;
        }
        
        let moveCooldown = false;
        
        document.addEventListener('keydown', (e) => {
            if (gameState.showChoices || gameState.currentDialogue) return;
            if (moveCooldown) return;
            
            const player = gameState.player;
            let newX = player.x;
            let newY = player.y;
            
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') {
                newY -= 1;
                player.direction = 'up';
                moveCooldown = true;
            } else if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') {
                newY += 1;
                player.direction = 'down';
                moveCooldown = true;
            } else if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') {
                newX -= 1;
                player.direction = 'left';
                moveCooldown = true;
            } else if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') {
                newX += 1;
                player.direction = 'right';
                moveCooldown = true;
            }
            
            if (moveCooldown) {
                if (isTileWalkable(newX, newY)) {
                    player.x = newX;
                    player.y = newY;
                }
                setTimeout(() => { moveCooldown = false; }, 150);
            }
            
            if ((e.key === 'e' || e.key === 'E' || e.key === 'Enter') && !gameState.showChoices) {
                checkInteraction();
            }
            
            e.preventDefault();
        });
        
        function checkInteraction() {
            const player = gameState.player;
            const px = player.x;
            const py = player.y;
            
            for (let npc of gameState.npcs) {
                const nx = Math.floor(npc.x / TILE_SIZE);
                const ny = Math.floor(npc.y / TILE_SIZE);
                
                if ((Math.abs(px - nx) === 1 && py === ny) || 
                    (Math.abs(py - ny) === 1 && px === nx)) {
                    startDialogue(npc);
                    return;
                }
            }
        }
        
        function update() {
            if (gameState.showChoices || gameState.currentDialogue) return;
            
            updateLocationName();
            updateHint();
        }
        
        function drawMap() {
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    const tile = map[y][x];
                    const px = x * TILE_SIZE;
                    const py = y * TILE_SIZE;
                    
                    if (tile === 1) {
                        ctx.fillStyle = '#2d4a2d';
                        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#3d5c3d';
                        ctx.fillRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                    } else if (tile === 2) {
                        ctx.fillStyle = '#8b7355';
                        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#a08060';
                        ctx.fillRect(px + 4, py + 4, TILE_SIZE - 8, TILE_SIZE - 8);
                    } else if (tile === 3) {
                        ctx.fillStyle = '#5a7a5a';
                        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#6a8a6a';
                        ctx.fillRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                    }
                }
            }
        }
        
        function drawBuilding(building) {
            const x = building.x * TILE_SIZE;
            const y = building.y * TILE_SIZE;
            const w = building.width * TILE_SIZE;
            const h = building.height * TILE_SIZE;
            
            ctx.fillStyle = building.color;
            ctx.fillRect(x + 10, y + 20, w - 20, h - 20);
            
            ctx.fillStyle = '#3a3a4a';
            ctx.fillRect(x + 10, y + 20, w - 20, 8);
            
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(x + 20, y + 35, 20, 20);
            ctx.fillRect(x + w - 50, y + 35, 20, 20);
            
            if (building.roofColor) {
                ctx.fillStyle = building.roofColor;
                ctx.beginPath();
                ctx.moveTo(x + 5, y + 20);
                ctx.lineTo(x + w / 2, y + 5);
                ctx.lineTo(x + w - 5, y + 20);
                ctx.closePath();
                ctx.fill();
            }
            
            ctx.fillStyle = '#ffd700';
            ctx.font = '8px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText(building.name, x + w / 2, y - 5);
        }
        
        function drawSprite(sprite, tileX, tileY, direction, frame) {
            if (!sprites[sprite]) return;
            
            const pixelX = tileX * TILE_SIZE + TILE_SIZE / 2;
            const pixelY = tileY * TILE_SIZE + TILE_SIZE / 2;
            
            ctx.save();
            ctx.translate(pixelX, pixelY);
            
            const spriteImg = sprites[sprite];
            let scale = 0.6;
            if (sprite === 'player') scale = 0.5;
            const w = spriteImg.width * scale;
            const h = spriteImg.height * scale;
            
            if (direction === 'left') {
                ctx.scale(-1, 1);
            }
            
            const bounce = Math.floor(frame) % 2 * 2;
            ctx.drawImage(spriteImg, -w/2, -h + bounce + 10, w, h);
            
            ctx.restore();
        }
        
        function drawNPC(npc) {
            const sprite = sprites[npc.sprite];
            if (!sprite) return;
            drawSprite(npc.sprite, npc.x, npc.y, 'down', 0);
            
            const player = gameState.player;
            const dist = Math.abs(player.x - npc.x) + Math.abs(player.y - npc.y);
            
            if (dist <= 1.5) {
                const pixelX = npc.x * TILE_SIZE + TILE_SIZE / 2;
                const pixelY = npc.y * TILE_SIZE;
                ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.beginPath();
                ctx.arc(pixelX, pixelY - 10, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 10px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('!', npc.x, npc.y - 28);
            }
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (bgForCollision.complete) {
                ctx.drawImage(bgForCollision, 0, 0, canvas.width, canvas.height);
            }
            
            const player = gameState.player;
            if (sprites.player) {
                drawSprite('player', player.x, player.y, player.direction, player.frame);
            } else {
                ctx.fillStyle = 'red';
                ctx.fillRect(player.x * TILE_SIZE, player.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
        
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        initBuildings();
        gameLoop();
        
        console.log('Legal Quest loaded! Use WASD/Arrows to move, E/Enter to interact.');
    </script>
</body>
</html>
